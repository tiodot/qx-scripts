async function processRequest(t){try{$.log("å¼€å§‹å¤„ç†å¾®ä¿¡è¯»ä¹¦ç™»å½•è¯·æ±‚...");const e=t.headers,s=e.vid||"";let i=parseRequestBody(t.body);const o={vid:s,requestBody:i,headers:e,captureTime:(new Date).toISOString()};$.msg(NOTIFY_TITLE,NOTIFY_SUCCESS_MSG,"VID: "+s);let r=JSON.stringify(o,null,2);if(debugMode&&$.log("å¾®ä¿¡è¯»ä¹¦ç™»å½•ä¿¡æ¯:\n"+r),enableGistUpload&&githubToken){const t=await pushToGist(r);t.success?$.msg(NOTIFY_TITLE,NOTIFY_GIST_SUCCESS,t.message||""):$.msg(NOTIFY_TITLE,NOTIFY_GIST_ERROR,t.message||"")}return t}catch(e){return $.log(`å¤„ç†è¯·æ±‚æ—¶å‡ºé”™: ${e}`),$.msg(NOTIFY_TITLE,NOTIFY_ERROR_MSG,e.toString()),t}}function parseRequestBody(t){if(!t)return{};try{const e=decodeURIComponent(t);if(e.trim().startsWith("{")&&e.trim().endsWith("}"))return JSON.parse(e);const s={};return e.split("&").forEach(t=>{const[e,i]=t.split("=");e&&i&&(s[e]=decodeURIComponent(i))}),s}catch{return{raw:t}}}async function pushToGist(t){try{if(!githubToken)return{success:!1,message:"GitHub Tokenæœªè®¾ç½®"};const e={Authorization:`token ${githubToken}`,"Content-Type":"application/json","User-Agent":"WeReadLoginMonitor"};if(!gistId)return await createNewGist(t,e);try{return await updateGist(t,e)}catch(s){return $.error(`æ›´æ–°Gistæ—¶å‡ºé”™: ${s}`),await createNewGist(t,e)}}catch(t){return $.error(`Gistæ“ä½œå‡ºé”™: ${t}`),{success:!1,message:`æ“ä½œå¤±è´¥: ${t.message||t}`}}}async function updateGist(t,e){const s={description:gistDescription,files:{[gistFilename]:{content:t}}},i=await $.patch({url:`https://api.github.com/gists/${gistId}`,headers:e,body:JSON.stringify(s)}).then(t=>(debugMode&&$.log(`Gistæ›´æ–°ç»“æžœ: ${JSON.stringify(t,null,2)}`),{status:t.statusCode,body:t.body}));return 200===i.status?(debugMode&&$.log(`Gistæ›´æ–°æˆåŠŸ: ${gistId}, æ–‡ä»¶: ${gistFilename}`),gistId||$.setVal("wr_gist_id",targetGistId),{success:!0,message:`Gistå·²æ›´æ–°: ${targetGistId}`}):($.log(`Gistæ›´æ–°å¤±è´¥: ${JSON.stringify(i)}`),{success:!1,message:`Gistæ›´æ–°å¤±è´¥: ${i.status}`})}async function createNewGist(t,e){try{const s={description:gistDescription,public:!1,files:{[gistFilename]:{content:t}}},i=await $.post({url:"https://api.github.com/gists",headers:e,body:JSON.stringify(s)}).then(t=>({status:t.statusCode,body:t.body}));if(201===i.status)try{const t=JSON.parse(i.body),e=t.id;if(e)return $.setVal("wr_gist_id",e),debugMode&&$.log(`æ–°Gistå·²åˆ›å»º: ${e}, æ–‡ä»¶: ${gistFilename}`),{success:!0,message:`æ–°Gistå·²åˆ›å»º: ${e}`}}catch(t){$.log(`è§£æžGiståˆ›å»ºå“åº”å¤±è´¥: ${t}`)}return $.log(`Giståˆ›å»ºå¤±è´¥: ${JSON.stringify(i)}`),{success:!1,message:`Giståˆ›å»ºå¤±è´¥: ${i.status}`}}catch(t){return $.log(`åˆ›å»ºGistæ—¶å‡ºé”™: ${t}`),{success:!1,message:`åˆ›å»ºå¤±è´¥: ${t.message||t}`}}}class QXEnv{constructor(t,e){if("undefined"==typeof $task)throw new Error("è¯·åœ¨Quantumult XçŽ¯å¢ƒä¸­è¿è¡Œæ­¤è„šæœ¬");this.name=t,this.opts=e||{},this.startTime=Date.now(),this.log(`ðŸ””${this.name}, å¼€å§‹!`)}done(t={}){const e=Date.now(),s=(e-this.startTime)/1e3;this.log("",`ðŸ””${this.name}, ç»“æŸ! ðŸ•› ${s} ç§’\n`),$done(t)}log(...t){console.log(`[${this.name}]`,...t)}error(...t){this.log(`â—ï¸[${this.name}][é”™è¯¯]`,...t)}msg(t="",e="",s="",i={}){"string"==typeof i?i={"open-url":i}:i&&"object"==typeof i||(i={});const o={};let r=i["open-url"]||i.url||i.openUrl||$open;r&&Object.assign(o,{"open-url":r});let n=i.mediaUrl||i["media-url"]||$media;n&&Object.assign(o,{"media-url":n});let a=i["update-pasteboard"]||i.updatePasteboard||$copy;a&&Object.assign(o,{"update-pasteboard":a}),$notification.post(t,subt,s,o)}getVal(t){return $prefs.valueForKey(t)}setVal(t,e){return $prefs.setValueForKey(e,t)}queryStr(t){return t&&"object"==typeof t?Object.keys(t).map(e=>`${e}=${encodeURIComponent(t[e])}`).join("&"):""}formatHeaders(t){t&&t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"],delete t.headers["content-type"],delete t.headers["content-length"]),void 0===t.followRedirect||t.followRedirect||(t.opts?t.opts.redirection=!1:t.opts={redirection:!1}),t.params&&(t.url+="?"+this.queryStr(t.params))}get(t){return this.formatHeaders(t),this.send(t)}post(t){return this.formatHeaders(t),t.method||(t.method="POST"),t.body&&t.headers&&!t.headers["Content-Type"]&&!t.headers["content-type"]&&(t.headers["content-type"]="application/x-www-form-urlencoded"),this.send(t)}patch(t){return t.method="PATCH",this.post(t)}send(t){const e=(t,e=1e3)=>Promise.race([t,new Promise((t,s)=>{setTimeout(()=>{s(new Error("è¯·æ±‚è¶…æ—¶"))},e)})]),s=$task.fetch(t).catch(t=>{throw this.log(`è¯·æ±‚å¤±è´¥: ${t}`),t});return this.opts.timeout?e(s,this.opts.timeout):s}}const $=new QXEnv("å¾®ä¿¡è¯»ä¹¦ç™»å½•ä¿¡æ¯ç›‘æŽ§");let githubToken=$.getVal("wr_github_token")||"",gistId=$.getVal("wr_gist_id")||"",gistFilename=$.getVal("wr_gist_filename")||"weread_login_info.json",gistDescription=$.getVal("wr_gist_description")||"å¾®ä¿¡è¯»ä¹¦ç™»å½•ä¿¡æ¯",enableGistUpload="true"===$.getVal("wr_enable_gist"),debugMode=!0;const NOTIFY_TITLE="å¾®ä¿¡è¯»ä¹¦ç™»å½•ä¿¡æ¯",NOTIFY_SUCCESS_MSG="ç™»å½•ä¿¡æ¯å·²æˆåŠŸæå–",NOTIFY_ERROR_MSG="ç™»å½•ä¿¡æ¯æå–å¤±è´¥",NOTIFY_GIST_SUCCESS="å·²æˆåŠŸä¸Šä¼ åˆ°Gist",NOTIFY_GIST_ERROR="Gistä¸Šä¼ å¤±è´¥";processRequest($request).catch(t=>{$.error(`å¤„ç†è¯·æ±‚æ—¶å‡ºé”™: ${t}`)}).finally(()=>{$.done()});