class QXEnv{constructor(e,t){if("undefined"==typeof $task)throw new Error("请在Quantumult X环境中运行此脚本");this.name=e,this.opts=t||{},this.startTime=Date.now(),this.log(`🔔${this.name}, 开始!`)}done(e={}){const t=Date.now(),o=(t-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${o} 秒\n`),$done(e)}log(...e){console.log(`[${this.name}]`,...e)}error(...e){this.log(`❗️[${this.name}][错误]`,...e)}msg(e="",t="",o="",r={}){"string"==typeof r?r={"open-url":r}:r&&"object"==typeof r||(r={});const s={};let n=r["open-url"]||r.url||r.openUrl||$open;n&&Object.assign(s,{"open-url":n});let a=r.mediaUrl||r["media-url"]||$media;a&&Object.assign(s,{"media-url":a});let i=r["update-pasteboard"]||r.updatePasteboard||$copy;i&&Object.assign(s,{"update-pasteboard":i}),$notification.post(e,subt,o,s)}getVal(e){return $prefs.valueForKey(e)}setVal(e,t){return $prefs.setValueForKey(t,e)}queryStr(e){return e&&"object"==typeof e?Object.keys(e).map(t=>`${t}=${encodeURIComponent(e[t])}`).join("&"):""}formatHeaders(e){e&&e.headers&&(delete e.headers["Content-Type"],delete e.headers["Content-Length"],delete e.headers["content-type"],delete e.headers["content-length"]),void 0===e.followRedirect||e.followRedirect||(e.opts?e.opts.redirection=!1:e.opts={redirection:!1}),e.params&&(e.url+="?"+this.queryStr(e.params))}get(e){return this.formatHeaders(e),this.send(e)}post(e){return this.formatHeaders(e),e.method||(e.method="POST"),e.body&&e.headers&&!e.headers["Content-Type"]&&!e.headers["content-type"]&&(e.headers["content-type"]="application/x-www-form-urlencoded"),this.send(e)}patch(e){return e.method="PATCH",this.post(e)}send(e){const t=(e,t=1e3)=>Promise.race([e,new Promise((e,o)=>{setTimeout(()=>{o(new Error("请求超时"))},t)})]),o=$task.fetch(e).catch(e=>{throw this.log(`请求失败: ${e}`),e});return this.opts.timeout?t(o,this.opts.timeout):o}}